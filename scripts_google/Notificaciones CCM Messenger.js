/**
 * SCRIPT DE NOTIFICACIONES CCM PARA MESSENGER
 * 
 * Sistema automatizado para env√≠o de notificaciones del CCM a un chat grupal
 * de Facebook Messenger para comunicaci√≥n con l√≠deres de zona y hermanas capacitadoras.
 * 
 * CARACTER√çSTICAS:
 * - Notificaciones autom√°ticas de pr√≥ximos cumplea√±os
 * - Notificaciones de pr√≥ximos ingresos al CCM
 * - Formato optimizado para Messenger (texto plano)
 * - Dirigido a l√≠deres de zona y hermanas capacitadoras
 * - Modo de prueba para testing seguro
 * - Manejo de errores y logging detallado
 * 
 * FUNCIONES PRINCIPALES:
 * - enviarNotificacionesCCMMessenger(): Proceso principal (ambas notificaciones)
 * - enviarSoloCumpleanosMessenger(): Solo cumplea√±os
 * - enviarSoloIngresosMessenger(): Solo ingresos al CCM
 * - probarNotificacionesMessenger(): Funci√≥n de prueba
 * - configurarTriggerMessenger(): Configura trigger autom√°tico
 * 
 * CONFIGURACI√ìN:
 * - Base de datos: dbConfig (Config.js)
 * - Messenger: MESSENGER_CONFIG (Config.js)
 * - Scope: RAMAS_AUTORIZADAS (Config.js)
 * 
 * AUDIENCIA:
 * - L√≠deres de zona
 * - Hermanas capacitadoras
 * - Personal de supervisi√≥n CCM
 * 
 * @author CCM Scripts
 * @version 1.0
 */

// === CONFIGURACI√ìN DE MODO PRUEBA ===
const MODO_PRUEBA_MESSENGER = false; // Cambiar a true para testing

/**
 * Funci√≥n principal que env√≠a todas las notificaciones CCM a Messenger
 * Incluye tanto cumplea√±os como pr√≥ximos ingresos
 */
function enviarNotificacionesCCMMessenger() {
  console.log("üì± Iniciando proceso de notificaciones CCM para Messenger");
  console.log(`üë• Destinatarios: ${MESSENGER_CONFIG.destinatarios}`);
  
  if (MODO_PRUEBA_MESSENGER) {
    console.log("üß™ *** MODO PRUEBA ACTIVADO ***");
    return probarNotificacionesMessenger();
  }
  
  // Modo producci√≥n - conectar a base de datos
  let conn;
  
  try {
    // Conectar a la base de datos
    const url = `jdbc:mysql://${dbConfig.host}:${dbConfig.port}/${dbConfig.dbName}?useUnicode=true&characterEncoding=utf8`;
    conn = Jdbc.getConnection(url, dbConfig.user, dbConfig.password);
    
    // Establecer collation para la sesi√≥n
    const collationStmt = conn.createStatement();
    collationStmt.execute("SET collation_connection = utf8mb4_unicode_ci");
    collationStmt.execute("SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci");
    collationStmt.close();
    
    console.log("‚úÖ Conexi√≥n a MySQL exitosa con collation configurado");
    
    // Enviar todas las notificaciones usando las funciones del MessengerNotifier
    const resultado = enviarTodasLasNotificacionesMessenger(conn, RAMA);
    
    if (resultado.success) {
      console.log(`üéâ Notificaciones CCM enviadas a Messenger: ${resultado.exitosos} exitosas`);
      if (resultado.fallidos > 0) {
        console.log(`‚ö†Ô∏è ${resultado.fallidos} notificaciones fallaron`);
      }
    } else {
      console.error("‚ùå Error en notificaciones a Messenger:", resultado.error || resultado.message);
    }
    
    return resultado;
    
  } catch (error) {
    console.error("‚ùå Error en enviarNotificacionesCCMMessenger:", error.toString());
    return { success: false, error: error.toString() };
  } finally {
    if (conn) {
      try {
        conn.close();
        console.log("‚úÖ Conexi√≥n a base de datos cerrada");
      } catch (error) {
        console.error("‚ö†Ô∏è Error al cerrar conexi√≥n:", error.toString());
      }
    }
  }
}

/**
 * Funci√≥n para enviar solo notificaciones de cumplea√±os a Messenger
 */
function enviarSoloCumpleanosMessenger() {
  console.log("üéÇ Enviando solo notificaciones de cumplea√±os a Messenger");
  
  let conn;
  
  try {
    const url = `jdbc:mysql://${dbConfig.host}:${dbConfig.port}/${dbConfig.dbName}?useUnicode=true&characterEncoding=utf8`;
    conn = Jdbc.getConnection(url, dbConfig.user, dbConfig.password);
    
    const collationStmt = conn.createStatement();
    collationStmt.execute("SET collation_connection = utf8mb4_unicode_ci");
    collationStmt.execute("SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci");
    collationStmt.close();
    
    console.log("‚úÖ Conexi√≥n a MySQL exitosa");
    
    const resultado = notificarProximosCumpleanosMessenger(conn, RAMA);
    
    if (resultado.success) {
      console.log("üéâ Notificaci√≥n de cumplea√±os enviada a Messenger exitosamente");
    } else {
      console.error("‚ùå Error en notificaci√≥n de cumplea√±os:", resultado.error || resultado.message);
    }
    
    return resultado;
    
  } catch (error) {
    console.error("‚ùå Error en enviarSoloCumpleanosMessenger:", error.toString());
    return { success: false, error: error.toString() };
  } finally {
    if (conn) {
      try {
        conn.close();
      } catch (error) {
        console.error("‚ö†Ô∏è Error al cerrar conexi√≥n:", error.toString());
      }
    }
  }
}

/**
 * Funci√≥n para enviar solo notificaciones de pr√≥ximos ingresos a Messenger
 */
function enviarSoloIngresosMessenger() {
  console.log("üìä Enviando solo notificaciones de pr√≥ximos ingresos a Messenger");
  
  let conn;
  
  try {
    const url = `jdbc:mysql://${dbConfig.host}:${dbConfig.port}/${dbConfig.dbName}?useUnicode=true&characterEncoding=utf8`;
    conn = Jdbc.getConnection(url, dbConfig.user, dbConfig.password);
    
    const collationStmt = conn.createStatement();
    collationStmt.execute("SET collation_connection = utf8mb4_unicode_ci");
    collationStmt.execute("SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci");
    collationStmt.close();
    
    console.log("‚úÖ Conexi√≥n a MySQL exitosa");
    
    const resultado = notificarProximosIngresosCCMMessenger(conn, RAMA);
    
    if (resultado.success) {
      console.log("üéâ Notificaci√≥n de pr√≥ximos ingresos enviada a Messenger exitosamente");
    } else {
      console.error("‚ùå Error en notificaci√≥n de ingresos:", resultado.error || resultado.message);
    }
    
    return resultado;
    
  } catch (error) {
    console.error("‚ùå Error en enviarSoloIngresosMessenger:", error.toString());
    return { success: false, error: error.toString() };
  } finally {
    if (conn) {
      try {
        conn.close();
      } catch (error) {
        console.error("‚ö†Ô∏è Error al cerrar conexi√≥n:", error.toString());
      }
    }
  }
}

/**
 * Funci√≥n de prueba que env√≠a notificaciones simuladas
 */
function probarNotificacionesMessenger() {
  console.log("üß™ Ejecutando prueba de notificaciones para Messenger...");
  
  try {
    // Verificar configuraci√≥n de Messenger
    if (!MESSENGER_CONFIG.enabled) {
      console.log("‚ö†Ô∏è Las notificaciones de Messenger est√°n deshabilitadas");
      return { success: false, message: "Notificaciones deshabilitadas" };
    }
    
    // Primero probar la conexi√≥n
    console.log("üîó Probando conexi√≥n b√°sica...");
    const pruebaConexion = probarConexionMessenger();
    
    if (!pruebaConexion.success) {
      console.error("‚ùå Fallo en prueba de conexi√≥n b√°sica");
      return pruebaConexion;
    }
    
    console.log("‚úÖ Conexi√≥n b√°sica exitosa, enviando notificaciones de prueba...");
    
    // Esperar un poco entre mensajes
    Utilities.sleep(3000);
    
    // Crear datos simulados para cumplea√±os
    const cumpleanosSimulados = [
      {
        id: 1, rama: 14, rDistrito: "Distrito Norte", tratamiento: "Elder Hatcher",
        nombreMisionero: "Elder Hatcher", nuevaEdad: 20, status: "CCM",
        correoMisional: "hatcher@train.missionary.org",
        fechaCumpleanos: new Date(2025, 7, 19) // 19 de agosto
      },
      {
        id: 2, rama: 14, rDistrito: "Distrito Sur", tratamiento: "Hermana Smedley",
        nombreMisionero: "Hermana Smedley", nuevaEdad: 20, status: "Virtual",
        correoMisional: "smedley@train.missionary.org",
        fechaCumpleanos: new Date(2025, 8, 26) // 26 de septiembre
      }
    ];
    
    // Enviar notificaci√≥n de cumplea√±os de prueba
    const mensajeCumpleanos = generarReporteProximosCumpleanosMessenger(cumpleanosSimulados, 14);
    const resultadoCumpleanos = enviarMensajeMessenger(mensajeCumpleanos);
    
    console.log("üéÇ Resultado cumplea√±os:", resultadoCumpleanos.success ? "‚úÖ Exitoso" : "‚ùå Fallido");
    
    // Esperar entre mensajes
    Utilities.sleep(3000);
    
    // Crear datos simulados para ingresos
    const ingresosSimulados = [
      {
        distrito: "C", rDistrito: "14C",
        fechaLlegada: new Date(2025, 7, 20), fechaSalida: new Date(2025, 8, 24),
        cantidad: 12, duracionSemanas: 6
      },
      {
        distrito: "D", rDistrito: "14D",
        fechaLlegada: new Date(2025, 7, 21), fechaSalida: new Date(2025, 8, 24),
        cantidad: 11, duracionSemanas: 6
      }
    ];
    
    // Enviar notificaci√≥n de ingresos de prueba
    const mensajeIngresos = generarReporteProximosIngresosCCMMessenger(ingresosSimulados, 14);
    const resultadoIngresos = enviarMensajeMessenger(mensajeIngresos);
    
    console.log("üìä Resultado ingresos:", resultadoIngresos.success ? "‚úÖ Exitoso" : "‚ùå Fallido");
    
    // Evaluar resultados generales
    const exitosos = [resultadoCumpleanos.success, resultadoIngresos.success].filter(r => r).length;
    const total = 2;
    
    if (exitosos === total) {
      console.log("üéâ Todas las pruebas de Messenger completadas exitosamente");
    } else {
      console.log(`‚ö†Ô∏è Pruebas parcialmente exitosas: ${exitosos}/${total}`);
    }
    
    return {
      success: exitosos > 0,
      exitosos: exitosos,
      total: total,
      resultados: {
        cumpleanos: resultadoCumpleanos,
        ingresos: resultadoIngresos
      }
    };
    
  } catch (error) {
    console.error("‚ùå Error en prueba de notificaciones:", error.toString());
    return { success: false, error: error.toString() };
  }
}

/**
 * Funci√≥n para configurar un trigger autom√°tico semanal
 */
function configurarTriggerMessenger() {
  try {
    console.log("‚è∞ Configurando trigger autom√°tico para notificaciones de Messenger...");
    
    // Eliminar triggers existentes
    const triggersExistentes = ScriptApp.getProjectTriggers();
    triggersExistentes.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'enviarNotificacionesCCMMessenger') {
        ScriptApp.deleteTrigger(trigger);
        console.log("üóëÔ∏è Trigger existente eliminado");
      }
    });
    
    // Crear nuevo trigger semanal (cada viernes a las 10:00 AM)
    // Diferente d√≠a que Telegram para distribuir las notificaciones
    ScriptApp.newTrigger('enviarNotificacionesCCMMessenger')
      .timeBased()
      .everyWeeks(1)
      .onWeekDay(ScriptApp.WeekDay.FRIDAY)
      .atHour(10)
      .create();
    
    console.log("‚úÖ Trigger configurado: enviarNotificacionesCCMMessenger cada viernes a las 10:00 AM");
    console.log("üìÖ Pr√≥xima ejecuci√≥n autom√°tica programada");
    console.log("üë• Destinatarios: L√≠deres de zona y hermanas capacitadoras");
    
    return { 
      success: true, 
      message: "Trigger configurado exitosamente para notificaciones semanales de Messenger" 
    };
    
  } catch (error) {
    console.error("‚ùå Error al configurar trigger:", error.toString());
    return { 
      success: false, 
      error: error.toString() 
    };
  }
}

/**
 * Funci√≥n para eliminar los triggers autom√°ticos de Messenger
 */
function eliminarTriggerMessenger() {
  try {
    console.log("üóëÔ∏è Eliminando triggers de notificaciones de Messenger...");
    
    const triggersExistentes = ScriptApp.getProjectTriggers();
    let triggersEliminados = 0;
    
    triggersExistentes.forEach(trigger => {
      if (trigger.getHandlerFunction() === 'enviarNotificacionesCCMMessenger') {
        ScriptApp.deleteTrigger(trigger);
        triggersEliminados++;
        console.log("üóëÔ∏è Trigger eliminado");
      }
    });
    
    if (triggersEliminados > 0) {
      console.log(`‚úÖ ${triggersEliminados} trigger(s) de Messenger eliminado(s)`);
    } else {
      console.log("‚ÑπÔ∏è No se encontraron triggers de Messenger para eliminar");
    }
    
    return { 
      success: true, 
      message: `${triggersEliminados} trigger(s) eliminado(s)` 
    };
    
  } catch (error) {
    console.error("‚ùå Error al eliminar triggers:", error.toString());
    return { 
      success: false, 
      error: error.toString() 
    };
  }
}

/**
 * Funci√≥n de estado que muestra informaci√≥n sobre los triggers configurados
 */
function estadoTriggersMessenger() {
  try {
    console.log("üìä Verificando estado de triggers de Messenger...");
    
    const triggersExistentes = ScriptApp.getProjectTriggers();
    const triggersMessenger = triggersExistentes.filter(trigger => 
      trigger.getHandlerFunction() === 'enviarNotificacionesCCMMessenger'
    );
    
    if (triggersMessenger.length === 0) {
      console.log("‚ÑπÔ∏è No hay triggers de Messenger configurados");
      console.log("üí° Usar configurarTriggerMessenger() para crear uno");
    } else {
      console.log(`‚úÖ Encontrados ${triggersMessenger.length} trigger(s) de Messenger:`);
      
      triggersMessenger.forEach((trigger, index) => {
        const tipo = trigger.getEventType();
        console.log(`   ${index + 1}. Tipo: ${tipo}`);
        
        if (tipo === ScriptApp.EventType.CLOCK) {
          console.log(`      ‚è∞ Programaci√≥n: ${trigger.getHandlerFunction()}`);
        }
      });
    }
    
    // Mostrar estado de configuraci√≥n de Messenger
    console.log(`üì± Messenger habilitado: ${MESSENGER_CONFIG.enabled}`);
    console.log(`üí¨ Chat: ${MESSENGER_CONFIG.chatNombre}`);
    console.log(`üë• Destinatarios: ${MESSENGER_CONFIG.destinatarios}`);
    console.log(`üéØ Rama configurada: ${RAMA}`);
    
    return { 
      success: true, 
      triggersCount: triggersMessenger.length,
      messengerEnabled: MESSENGER_CONFIG.enabled
    };
    
  } catch (error) {
    console.error("‚ùå Error al verificar estado:", error.toString());
    return { 
      success: false, 
      error: error.toString() 
    };
  }
}
