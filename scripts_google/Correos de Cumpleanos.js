/**
 * SCRIPT DE CORREOS AUTOM√ÅTICOS DE CUMPLEA√ëOS PARA MISIONEROS CCM
 * 
 * Sistema automatizado para env√≠o de correos de cumplea√±os personalizados
 * a misioneros seg√∫n su estatus y rama asignada.
 * 
 * CARACTER√çSTICAS:
 * - Env√≠o autom√°tico diario de correos de cumplea√±os
 * - Personalizaci√≥n seg√∫n g√©nero (√âlder/Hermana)
 * - Filtrado por rama y estatus de misionero
 * - Modo de prueba para testing seguro
 * - Manejo de errores y logging detallado
 * - Soporte para m√∫ltiples ramas y estatus
 * 
 * FUNCIONES PRINCIPALES:
 * - enviarCorreosCumpleanos(): Proceso principal diario
 * - probarCorreosCumpleanos(): Funci√≥n de prueba con datos simulados
 * - obtenerEstadisticasCumpleanos(): Estad√≠sticas para an√°lisis
 * 
 * CONFIGURACI√ìN:
 * - Base de datos: dbConfig (Config.js)
 * - Remitente: REMITENTE_EMAIL, REMITENTE_NOMBRE (Config.js)
 * - Scope: RAMAS_AUTORIZADAS, CONFIG_ESTATUS_POR_RAMA (Config.js)
 * 
 * MODO PRUEBA:
 * - Cambiar MODO_PRUEBA a true para testing
 * - Configurar CORREO_PRUEBA y otros par√°metros de prueba
 * 
 * USO:
 * - Ejecutar enviarCorreosCumpleanos() con trigger diario a las 6:00 AM
 * - Usar probarCorreosCumpleanos() para pruebas
 * 
 * @author CCM Scripts
 * @version 4.0
 */

// === CONFIGURACI√ìN DE MODO PRUEBA ===
const MODO_PRUEBA = false; // Cambiar a false para producci√≥n
const SIMULAR_HERMANA = false; // true para hermana, false para √©lder
const CORREO_PRUEBA = "jpmarichal@gmail.com"; // Tu correo para recibir las pruebas
const NOMBRE_PRUEBA = "Juan Pablo Marichal"; // Tu nombre para la prueba

// === CONFIGURACI√ìN DE SCOPE DE DESTINATARIOS ===
// Todas las variables de configuraci√≥n est√°n centralizadas en Config.js

/**
 * Funci√≥n principal que se debe ejecutar diariamente
 * Se recomienda configurar un trigger diario a las 6:00 AM
 */
function enviarCorreosCumpleanos() {
  console.log("üéÇ Iniciando proceso de correos de cumplea√±os");
  
  if (MODO_PRUEBA) {
    console.log("üß™ *** MODO PRUEBA ACTIVADO ***");
    console.log(`üìß Los correos se enviar√°n a: ${CORREO_PRUEBA}`);
    console.log(`üë§ Simulando: ${SIMULAR_HERMANA ? 'Hermana' : '√âlder'}`);
    
    // En modo prueba, usar datos simulados
    const misioneroSimulado = crearMisioneroSimulado();
    console.log(`üìã Datos simulados: ${misioneroSimulado.nombre} (Rama ${misioneroSimulado.rama}, ${misioneroSimulado.status})`);
    
    try {
      enviarCorreoIndividual(misioneroSimulado);
      console.log(`‚úÖ Correo de prueba enviado exitosamente a ${CORREO_PRUEBA}`);
      console.log(`üéâ Proceso de prueba completado`);
    } catch (error) {
      console.error(`‚ùå Error enviando correo de prueba: ${error.message}`);
    }
    
    return;
  }
  
  // Modo producci√≥n - conectar a base de datos
  let conn;
  
  try {
    // Conectar a la base de datos
    const url = `jdbc:mysql://${dbConfig.host}:${dbConfig.port}/${dbConfig.dbName}?useUnicode=true&characterEncoding=utf8`;
    conn = Jdbc.getConnection(url, dbConfig.user, dbConfig.password);
    
    // Establecer collation para la sesi√≥n
    const collationStmt = conn.createStatement();
    collationStmt.execute("SET collation_connection = utf8mb4_unicode_ci");
    collationStmt.execute("SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci");
    collationStmt.close();
    
    console.log("‚úÖ Conexi√≥n a MySQL exitosa con collation configurado");
    
    // Obtener misioneros que cumplen a√±os hoy
    const cumpleaneros = obtenerCumpleanerosHoy(conn);
    console.log(`üìã Encontrados ${cumpleaneros.length} misioneros que cumplen a√±os hoy`);
    
    // Validar si hay cumplea√±eros
    if (cumpleaneros.length === 0) {
      console.log("‚ÑπÔ∏è No hay misioneros que cumplan a√±os hoy en las ramas autorizadas");
      console.log(`üéØ Ramas monitoreadas: ${RAMAS_AUTORIZADAS.join(', ')}`);
      RAMAS_AUTORIZADAS.forEach(rama => {
        console.log(`   Rama ${rama}: ${obtenerEstatusValidosPorRama(rama).join(', ')}`);
      });
      console.log("‚úÖ Proceso completado exitosamente - Sin cumplea√±eros hoy");
      return; // Terminar elegantemente
    }
    
    // Enviar correos
    let enviadosExitosos = 0;
    for (const misionero of cumpleaneros) {
      try {
        enviarCorreoIndividual(misionero);
        enviadosExitosos++;
        console.log(`‚úÖ Correo enviado a ${misionero.nombre} (Rama ${misionero.rama}, ${misionero.status})`);
      } catch (error) {
        // Pausa incluso si hay un error para no sobrecargar en caso de fallos repetidos
        Utilities.sleep(1000); 
        console.error(`‚ùå Error enviando correo a ${misionero.nombre}: ${error.message}`);
      }
    }
    
    console.log(`üéâ Proceso completado: ${enviadosExitosos}/${cumpleaneros.length} correos enviados exitosamente`);
    
  } catch (error) {
    console.error(`‚ùå Error cr√≠tico: ${error.message}`);
    throw error;
  } finally {
    if (conn && !conn.isClosed()) {
      conn.close();
    }
  }
}

/**
 * Crea un misionero simulado para pruebas
 */
function crearMisioneroSimulado() {
  const esTresSemanas = Math.random() < 0.3; // 30% probabilidad de ser de 3 semanas
  const rama = RAMAS_AUTORIZADAS[Math.floor(Math.random() * RAMAS_AUTORIZADAS.length)];
  const estatusValidos = obtenerEstatusValidosPorRama(rama);
  const status = estatusValidos[Math.floor(Math.random() * estatusValidos.length)];
  
  // Generar tratamiento correcto
  let tratamiento;
  if (SIMULAR_HERMANA) {
    const apellido = NOMBRE_PRUEBA.split(' ')[1] || NOMBRE_PRUEBA.split(' ')[0];
    tratamiento = `Hermana ${apellido}`;
  } else {
    const apellido = NOMBRE_PRUEBA.split(' ')[1] || NOMBRE_PRUEBA.split(' ')[0];
    tratamiento = `√âlder ${apellido}`;
  }
  
  return {
    id: 999999,
    tipo: SIMULAR_HERMANA ? 'Sis' : 'Eld',
    tratamiento: tratamiento,
    nombre: NOMBRE_PRUEBA,
    nuevaEdad: 20 + Math.floor(Math.random() * 5), // Edad entre 20-24
    tresSemanas: esTresSemanas,
    correoMisional: CORREO_PRUEBA,
    correoPersonal: CORREO_PRUEBA,
    status: status,
    rama: rama
  };
}

/**
 * Obtiene los misioneros que cumplen a√±os hoy (utilizando vwCumpleanerosDeHoy)
 */
function obtenerCumpleanerosHoy(conn) {
  // Construir condiciones din√°micas para cada rama autorizada
  const condicionesRama = RAMAS_AUTORIZADAS.map(rama => {
    const estatusValidos = obtenerEstatusValidosPorRama(rama);
    const estatusString = estatusValidos.map(s => `'${s}'`).join(',');
    return `(m.Rama = ${rama} AND m.Status IN (${estatusString}))`;
  }).join(' OR ');

  const sql = `
    SELECT 
      m.ID,
      m.Tipo,
      m.Tratamiento,
      m.Nombre_del_misionero,
      m.Nueva_Edad,
      m.tres_semanas,
      m.Correo_Misional,
      m.Correo_Personal,
      m.Status,
      m.Rama
    FROM vwCumpleanerosDeHoy m
    WHERE (${condicionesRama})
  `;
  
  console.log(`üìã Consulta SQL generada: ${sql}`);
  
  const stmt = conn.createStatement();
  const results = stmt.executeQuery(sql);
  const cumpleaneros = [];
  
  while (results.next()) {
    cumpleaneros.push({
      id: results.getInt('ID'),
      tipo: results.getString('Tipo'),
      tratamiento: results.getString('Tratamiento'),
      nombre: results.getString('Nombre_del_misionero'),
      nuevaEdad: results.getInt('Nueva_Edad'),
      tresSemanas: results.getBoolean('tres_semanas'),
      correoMisional: results.getString('Correo_Misional'),
      correoPersonal: results.getString('Correo_Personal'),
      status: results.getString('Status'),
      rama: results.getInt('Rama')
    });
  }
  
  results.close();
  stmt.close();
  return cumpleaneros;
}

/**
 * Env√≠a el correo de cumplea√±os personalizado a un misionero individual
 */
function enviarCorreoIndividual(misionero) {
  console.log("üì® Iniciando env√≠o de correo...");
  
  const esHermana = misionero.tipo === 'Sis';
  const esTresSemanas = misionero.tresSemanas;
  
  console.log(`üë§ Procesando: ${esHermana ? 'Hermana' : '√âlder'} (${misionero.tratamiento})`);
  
  // En modo prueba, usar correo de prueba
  const correoDestino = MODO_PRUEBA ? CORREO_PRUEBA : misionero.correoMisional;
  const correoPersonal = MODO_PRUEBA ? null : misionero.correoPersonal; // No usar BCC en pruebas
  
  console.log(`üìß Correo destino: ${correoDestino}`);
  
  if (!correoDestino) {
    throw new Error('No se encontr√≥ correo de destino');
  }
  
  // Generar contenido del mensaje
  console.log("üìù Generando contenido del mensaje...");
  const { asunto, cuerpoHtml } = generarMensajeCumpleanos(misionero, esHermana, esTresSemanas);
  console.log(`üìã Asunto generado: ${asunto}`);
  
  // Configurar opciones de env√≠o
  const opciones = {
    htmlBody: cuerpoHtml,
    name: REMITENTE_NOMBRE,
    from: REMITENTE_EMAIL
  };
  
  // Agregar BCC al correo personal si existe y no estamos en modo prueba
  if (!MODO_PRUEBA && correoPersonal && correoPersonal !== correoDestino) {
    opciones.bcc = correoPersonal;
  }
  
  // Modificar asunto en modo prueba
  const asuntoFinal = MODO_PRUEBA ? `[PRUEBA] ${asunto}` : asunto;
  console.log(`üìÆ Asunto final: ${asuntoFinal}`);
  
  // Enviar correo usando Gmail directamente
  console.log("üöÄ Enviando correo v√≠a Gmail...");
  GmailApp.sendEmail(
    correoDestino,
    asuntoFinal,
    '', // texto plano (vac√≠o porque usamos HTML)
    opciones
  );
  console.log("‚úÖ Correo enviado exitosamente");
}

/**
 * Genera el mensaje personalizado de cumplea√±os
 */
function generarMensajeCumpleanos(misionero, esHermana, esTresSemanas) {
  const tratamiento = misionero.tratamiento || (esHermana ? 'Hermana' : '√âlder');
  const edad = misionero.nuevaEdad;
  
  // Seleccionar pasaje b√≠blico aleatorio
  const pasaje = seleccionarPasajeBiblico();
  
  // Generar asunto (sin emojis para mejor compatibilidad)
  const asunto = `¬°Feliz Cumplea√±os ${tratamiento}!`;
  
  let cuerpoHtml;
  
  if (esTresSemanas) {
    // Misioneros de tres semanas: espa√±ol primero, ingl√©s segundo
    cuerpoHtml = generarMensajeEspanolIngles(tratamiento, edad, pasaje, esHermana);
  } else {
    // Misioneros regulares: ingl√©s primero, espa√±ol segundo
    cuerpoHtml = generarMensajeInglesEspanol(tratamiento, edad, pasaje, esHermana);
  }
  
  return { asunto, cuerpoHtml };
}

/**
 * Convierte emojis a c√≥digos HTML para mejor compatibilidad
 */
function convertirEmojisAHTML(texto) {
  return texto
    .replace(/üéÇ/g, '&#127874;')
    .replace(/üéâ/g, '&#127881;')
    .replace(/üéà/g, '&#127880;')
    .replace(/üí´/g, '&#128171;')
    .replace(/üéä/g, '&#127882;')
    .replace(/üíô/g, '&#128153;')
    .replace(/üìß/g, '&#128231;')
    .replace(/üåü/g, '&#127775;');
}

/**
 * Genera mensaje con espa√±ol primero (para misioneros de 3 semanas)
 */
function generarMensajeEspanolIngles(tratamiento, edad, pasaje, esHermana) {
  const pronombre = esHermana ? 'querida' : 'querido';
  const genero = esHermana ? 'a' : 'o';
  
  const contenido = `
    <html>
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background-color: #f8f9fa;">
      <div style="background: linear-gradient(135deg, #1f4e79, #2e5984); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
        <h1 style="margin: 0; font-size: 28px;">üéÇ ¬°Feliz Cumplea√±os! üéâ</h1>
      </div>
      
      <div style="padding: 30px; background: white; border-radius: 0 0 10px 10px;">
        <!-- MENSAJE EN ESPA√ëOL -->
        <div style="margin-bottom: 40px;">
          <h2 style="color: #1f4e79; margin-bottom: 20px;">üåü Mensaje en Espa√±ol</h2>
          <p style="font-size: 16px; line-height: 1.6;">
            ${pronombre.charAt(0).toUpperCase() + pronombre.slice(1)} ${tratamiento},
          </p>
          <p style="font-size: 16px; line-height: 1.6;">
            ¬°Hoy es un d√≠a muy especial! üéà En este ${edad}¬∫ cumplea√±os, queremos que sepa lo mucho que valoramos su servicio al estar dedicad${genero} en la obra del Se√±or. 
          </p>
          <p style="font-size: 16px; line-height: 1.6;">
            Su ejemplo de fe, obediencia y amor por los dem√°s es una inspiraci√≥n para todos nosotros en el Centro de Capacitaci√≥n Misional. üí´
          </p>
          <div style="background: #e8f4f8; padding: 20px; border-left: 4px solid #1f4e79; margin: 20px 0;">
            <p style="font-style: italic; margin: 0; color: #2c3e50;">
              <strong>Escritura para reflexionar:</strong><br>
              "${pasaje.texto}"<br>
              <small>‚Äî ${pasaje.referencia}</small>
            </p>
          </div>
          <p style="font-size: 16px; line-height: 1.6;">
            Que el Se√±or contin√∫e bendici√©ndol${genero} en este nuevo a√±o de vida y en su servicio misional. ¬°Disfrute su d√≠a especial! üéä
          </p>
          <p style="font-size: 16px; line-height: 1.6;">
            Con cari√±o y mejores deseos,<br>
            <strong>Presidente Marichal</strong><br>
            <em>Primer Consejero de la Presidencia de Rama</em><br>
            <em>Rama 14 CCM</em><br>
            <small>üìß CCM: ${CORREO_MISIONAL}</small><br>
            <small>üìß Personal: ${CORREO_PERSONAL}</small> üíô
          </p>
        </div>
        
        <hr style="border: none; height: 2px; background: linear-gradient(to right, #1f4e79, #e0e0e0, #1f4e79); margin: 40px 0;">
        
        <!-- MENSAJE EN INGL√âS -->
        <div>
          <h2 style="color: #1f4e79; margin-bottom: 20px;">üåü English Message</h2>
          <p style="font-size: 16px; line-height: 1.6;">
            Dear ${tratamiento},
          </p>
          <p style="font-size: 16px; line-height: 1.6;">
            Today is a very special day! üéà On this ${edad}${getOrdinalSuffix(edad)} birthday, we want you to know how much we value your dedicated service in the Lord's work.
          </p>
          <p style="font-size: 16px; line-height: 1.6;">
            Your example of faith, obedience, and love for others is an inspiration to all of us at the Missionary Training Center. üí´
          </p>
          <div style="background: #e8f4f8; padding: 20px; border-left: 4px solid #1f4e79; margin: 20px 0;">
            <p style="font-style: italic; margin: 0; color: #2c3e50;">
              <strong>Scripture to ponder:</strong><br>
              "${pasaje.textoIngles}"<br>
              <small>‚Äî ${pasaje.referencia}</small>
            </p>
          </div>
          <p style="font-size: 16px; line-height: 1.6;">
            May the Lord continue to bless you in this new year of life and in your missionary service. Enjoy your special day! üéä
          </p>
          <p style="font-size: 16px; line-height: 1.6;">
            With love and best wishes,<br>
            <strong>President Marichal</strong><br>
            <em>First Counselor in the Branch Presidency</em><br>
            <em>Branch 14 MTC</em><br>
            <small>üìß MTC: ${CORREO_MISIONAL}</small><br>
            <small>üìß Personal: ${CORREO_PERSONAL}</small> üíô
          </p>
        </div>
      </div>
      
      <div style="text-align: center; padding: 20px; color: #666; font-size: 12px;">
        Centro de Capacitaci√≥n Misional
      </div>
    </div>
    </body>
    </html>
  `;
  
  return convertirEmojisAHTML(contenido);
}

/**
 * Genera mensaje con ingl√©s primero (para misioneros regulares)
 */
function generarMensajeInglesEspanol(tratamiento, edad, pasaje, esHermana) {
  const pronombre = esHermana ? 'querida' : 'querido';
  const genero = esHermana ? 'a' : 'o';
  
  const contenido = `
    <html>
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background-color: #f8f9fa;">
      <div style="background: linear-gradient(135deg, #1f4e79, #2e5984); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0;">
        <h1 style="margin: 0; font-size: 28px;">üéÇ Happy Birthday! üéâ</h1>
      </div>
      
      <div style="padding: 30px; background: white; border-radius: 0 0 10px 10px;">
        <!-- MENSAJE EN INGL√âS -->
        <div style="margin-bottom: 40px;">
          <h2 style="color: #1f4e79; margin-bottom: 20px;">üåü English Message</h2>
          <p style="font-size: 16px; line-height: 1.6;">
            Dear ${tratamiento},
          </p>
          <p style="font-size: 16px; line-height: 1.6;">
            Today is a very special day! üéà On this ${edad}${getOrdinalSuffix(edad)} birthday, we want you to know how much we value your dedicated service in the Lord's work.
          </p>
          <p style="font-size: 16px; line-height: 1.6;">
            Your example of faith, obedience, and love for others is an inspiration to all of us at the Missionary Training Center. üí´
          </p>
          <div style="background: #e8f4f8; padding: 20px; border-left: 4px solid #1f4e79; margin: 20px 0;">
            <p style="font-style: italic; margin: 0; color: #2c3e50;">
              <strong>Scripture to ponder:</strong><br>
              "${pasaje.textoIngles}"<br>
              <small>‚Äî ${pasaje.referencia}</small>
            </p>
          </div>
          <p style="font-size: 16px; line-height: 1.6;">
            May the Lord continue to bless you in this new year of life and in your missionary service. Enjoy your special day! üéä
          </p>
          <p style="font-size: 16px; line-height: 1.6;">
            With love and best wishes,<br>
            <strong>President Marichal</strong><br>
            <em>First Counselor in the Branch Presidency</em><br>
            <em>Branch 14 MTC</em><br>
            <small>üìß MTC: ${CORREO_MISIONAL}</small><br>
            <small>üìß Personal: ${CORREO_PERSONAL}</small> üíô
          </p>
        </div>
        
        <hr style="border: none; height: 2px; background: linear-gradient(to right, #1f4e79, #e0e0e0, #1f4e79); margin: 40px 0;">
        
        <!-- MENSAJE EN ESPA√ëOL -->
        <div>
          <h2 style="color: #1f4e79; margin-bottom: 20px;">üåü Mensaje en Espa√±ol</h2>
          <p style="font-size: 16px; line-height: 1.6;">
            ${pronombre.charAt(0).toUpperCase() + pronombre.slice(1)} ${tratamiento},
          </p>
          <p style="font-size: 16px; line-height: 1.6;">
            ¬°Hoy es un d√≠a muy especial! üéà En este ${edad}¬∫ cumplea√±os, queremos que sepa lo mucho que valoramos su servicio dedicad${genero} en la obra del Se√±or.
          </p>
          <p style="font-size: 16px; line-height: 1.6;">
            Su ejemplo de fe, obediencia y amor por los dem√°s es una inspiraci√≥n para todos nosotros en el Centro de Capacitaci√≥n Misional. üí´
          </p>
          <div style="background: #e8f4f8; padding: 20px; border-left: 4px solid #1f4e79; margin: 20px 0;">
            <p style="font-style: italic; margin: 0; color: #2c3e50;">
              <strong>Escritura para reflexionar:</strong><br>
              "${pasaje.texto}"<br>
              <small>‚Äî ${pasaje.referencia}</small>
            </p>
          </div>
          <p style="font-size: 16px; line-height: 1.6;">
            Que el Se√±or contin√∫e bendici√©ndol${genero} en este nuevo a√±o de vida y en su servicio misional. ¬°Disfrute su d√≠a especial! üéä
          </p>
          <p style="font-size: 16px; line-height: 1.6;">
            Con cari√±o y mejores deseos,<br>
            <strong>Presidente Marichal</strong><br>
            <em>Primer Consejero de la Presidencia de Rama</em><br>
            <em>Rama 14 CCM</em><br>
            <small>üìß CCM: ${CORREO_MISIONAL}</small><br>
            <small>üìß Personal: ${CORREO_PERSONAL}</small> üíô
          </p>
        </div>
      </div>
      
      <div style="text-align: center; padding: 20px; color: #666; font-size: 12px;">
        Centro de Capacitaci√≥n Misional
      </div>
    </div>
    </body>
    </html>
  `;
  
  return convertirEmojisAHTML(contenido);
}

/**
 * Selecciona un pasaje b√≠blico inspirador aleatorio
 */
function seleccionarPasajeBiblico() {
  const pasajes = [
    {
      referencia: "D. y C. 4:2",
      texto: "Por tanto, oh vosotros que os embarc√°is en el servicio de Dios, mirad que le sirv√°is con todo vuestro coraz√≥n, alma, mente y fuerza, para que aparezc√°is sin culpa ante Dios en el √∫ltimo d√≠a.",
      textoIngles: "Therefore, O ye that embark in the service of God, see that ye serve him with all your heart, might, mind and strength, that ye may stand blameless before God at the last day."
    },
    {
      referencia: "Alma 26:12",
      texto: "S√≠, s√© que nada soy; en cuanto a mi fuerza, soy d√©bil; por tanto, no me gloriar√© en m√≠ mismo, sino que me gloriar√© en mi Dios, porque con su fuerza puedo hacer todas las cosas.",
      textoIngles: "Yea, I know that I am nothing; as to my strength I am weak; therefore I will not boast of myself, but I will boast of my God, for in his strength I can do all things."
    },
    {
      referencia: "D. y C. 84:88",
      texto: "Y quien os reciba, all√≠ estar√© yo tambi√©n, porque ir√© delante de vosotros. Estar√© a vuestra derecha y a vuestra izquierda, y mi Esp√≠ritu estar√° en vuestros corazones, y mis √°ngeles os rodear√°n para sosteneros.",
      textoIngles: "And whoso receiveth you, there I will be also, for I will go before your face. I will be on your right hand and on your left, and my Spirit shall be in your hearts, and mine angels round about you, to bear you up."
    },
    {
      referencia: "1 Nefi 3:7",
      texto: "Y aconteci√≥ que yo, Nefi, dije a mi padre: Ir√© y har√© lo que el Se√±or ha mandado, porque s√© que √©l nunca da mandamientos a los hijos de los hombres sin antes prepararles la v√≠a para que cumplan lo que les ha mandado.",
      textoIngles: "And it came to pass that I, Nephi, said unto my father: I will go and do the things which the Lord hath commanded, for I know that the Lord giveth no commandments unto the children of men, save he shall prepare a way for them that they may accomplish the thing which he commandeth them."
    },
    {
      referencia: "D. y C. 68:6",
      texto: "Por tanto, tened buen √°nimo, y no tem√°is, porque yo, el Se√±or, estoy con vosotros y os sostendr√©; y dar√©is testimonio de m√≠, s√≠, Jesucristo, de que yo soy el Hijo del Dios viviente, que fui y que soy y que he de venir.",
      textoIngles: "Wherefore, be of good cheer, and do not fear, for I the Lord am with you, and will stand by you; and ye shall bear record of me, even Jesus Christ, that I am the Son of the living God, that I was, that I am, and that I am to come."
    },
    {
      referencia: "Isa√≠as 6:8",
      texto: "Despu√©s o√≠ la voz del Se√±or, que dec√≠a: ¬øA qui√©n enviar√©, y qui√©n ir√° por nosotros? Entonces respond√≠ yo: Heme aqu√≠, env√≠ame a m√≠.",
      textoIngles: "Also I heard the voice of the Lord, saying, Whom shall I send, and who will go for us? Then said I, Here am I; send me."
    },
    {
      referencia: "Mateo 28:19-20",
      texto: "Por tanto, id, y haced disc√≠pulos a todas las naciones, bautiz√°ndolos en el nombre del Padre, y del Hijo, y del Esp√≠ritu Santo; ense√±√°ndoles que guarden todas las cosas que os he mandado; y he aqu√≠ yo estoy con vosotros todos los d√≠as, hasta el fin del mundo.",
      textoIngles: "Go ye therefore, and teach all nations, baptizing them in the name of the Father, and of the Son, and of the Holy Ghost: Teaching them to observe all things whatsoever I have commanded you: and, lo, I am with you always, even unto the end of the world."
    },
    {
      referencia: "D. y C. 100:7",
      texto: "Por tanto, no os preocup√©is por el ma√±ana, porque no sab√©is lo que un d√≠a puede traer. Por tanto, no os angusti√©is por el ma√±ana. Dios os dar√°, en la hora misma, s√≠, en el momento preciso, lo que deb√©is decir.",
      textoIngles: "Therefore, take no thought for the morrow, for what ye shall eat, or what ye shall drink, or wherewithal ye shall be clothed. For, consider the lilies of the field, how they grow, they toil not, neither do they spin; and the kingdoms of the world, in all their glory, are not arrayed like one of these."
    }
  ];
  
  const indiceAleatorio = Math.floor(Math.random() * pasajes.length);
  return pasajes[indiceAleatorio];
}

/**
 * Obtiene el sufijo ordinal en ingl√©s (st, nd, rd, th)
 */
function getOrdinalSuffix(num) {
  const j = num % 10;
  const k = num % 100;
  if (j == 1 && k != 11) return "st";
  if (j == 2 && k != 12) return "nd";
  if (j == 3 && k != 13) return "rd";
  return "th";
}

/**
 * Funci√≥n para configurar el trigger autom√°tico diario
 * Ejecutar esta funci√≥n UNA SOLA VEZ para configurar la automatizaci√≥n
 */
function configurarTriggerDiario() {
  // Eliminar triggers existentes para evitar duplicados
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'enviarCorreosCumpleanos') {
      ScriptApp.deleteTrigger(trigger);
    }
  });
  
  // Crear nuevo trigger diario a las 6:00 AM
  ScriptApp.newTrigger('enviarCorreosCumpleanos')
    .timeBased()
    .everyDays(1)
    .atHour(6)
    .create();
  
  console.log('‚úÖ Trigger diario configurado para las 6:00 AM');
}

/**
 * Funci√≥n espec√≠fica para ejecutar pruebas del sistema
 * Ejecuta esta funci√≥n para probar el sistema sin afectar la base de datos
 */
function ejecutarPrueba() {
  try {
    console.log("üß™ ===== INICIANDO PRUEBA DEL SISTEMA =====");
    
    // Verificar configuraci√≥n
    console.log(`üìß Correo de prueba: ${CORREO_PRUEBA}`);
    console.log(`üë§ Tipo de misionero: ${SIMULAR_HERMANA ? 'Hermana' : '√âlder'}`);
    console.log(`üè¢ Ramas autorizadas: ${RAMAS_AUTORIZADAS.join(', ')}`);
    
    // Crear misionero simulado
    console.log("üìã Creando misionero simulado...");
    const misioneroSimulado = crearMisioneroSimulado();
    console.log("üìã Datos del misionero simulado:");
    console.log(`   Nombre: ${misioneroSimulado.nombre}`);
    console.log(`   Tipo: ${misioneroSimulado.tipo} (${misioneroSimulado.tratamiento})`);
    console.log(`   Edad: ${misioneroSimulado.nuevaEdad} a√±os`);
    console.log(`   Tres semanas: ${misioneroSimulado.tresSemanas ? 'S√≠' : 'No'}`);
    console.log(`   Rama: ${misioneroSimulado.rama}`);
    console.log(`   Status: ${misioneroSimulado.status}`);
    console.log(`   Orden del mensaje: ${misioneroSimulado.tresSemanas ? 'Espa√±ol ‚Üí Ingl√©s' : 'Ingl√©s ‚Üí Espa√±ol'}`);
    
    // Enviar correo de prueba
    console.log("üì§ Enviando correo de prueba...");
    enviarCorreoIndividual(misioneroSimulado);
    console.log("‚úÖ ¬°Correo de prueba enviado exitosamente!");
    console.log(`üì¨ Revisa tu bandeja de entrada en: ${CORREO_PRUEBA}`);
    console.log("üéâ Prueba completada exitosamente");
    
  } catch (error) {
    console.error(`‚ùå Error en la prueba: ${error.message}`);
    console.error(`‚ùå Stack trace: ${error.stack}`);
    console.error("üîß Verifica las configuraciones y permisos de Gmail");
    throw error; // Re-lanzar el error para que se vea en los logs
  }
  
  console.log("üß™ ===== FIN DE LA PRUEBA =====");
}

/**
 * Funci√≥n para probar el env√≠o de correos (solo para testing)
 * Busca misioneros que cumplieron a√±os en los √∫ltimos 7 d√≠as
 */
function probarEnvioCorreos() {
  console.log("üß™ Funci√≥n de prueba - buscando cumplea√±eros recientes");
  let conn;
  
  try {
    const url = `jdbc:mysql://${dbConfig.host}:${dbConfig.port}/${dbConfig.dbName}?useUnicode=true&characterEncoding=utf8`;
    conn = Jdbc.getConnection(url, dbConfig.user, dbConfig.password);
    
    // Establecer collation para la sesi√≥n
    const collationStmt = conn.createStatement();
    collationStmt.execute("SET collation_connection = utf8mb4_unicode_ci");
    collationStmt.execute("SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci");
    collationStmt.close();
    
    // Construir condiciones din√°micas para cada rama autorizada
    const condicionesRama = RAMAS_AUTORIZADAS.map(rama => {
      const estatusValidos = obtenerEstatusValidosPorRama(rama);
      const estatusString = estatusValidos.map(s => `'${s}'`).join(',');
      return `(m.Rama = ${rama} AND m.Status IN (${estatusString}))`;
    }).join(' OR ');
    
    // Buscar misioneros que cumplieron a√±os en los √∫ltimos 7 d√≠as
    // Nota: Esta funci√≥n usa vwMisioneros directamente porque busca cumplea√±os pasados, 
    // no del d√≠a siguiente como la funci√≥n principal
    const sql = `
      SELECT 
        m.ID,
        m.Tipo,
        m.Tratamiento,
        m.Nombre_del_misionero,
        m.Edad + 1 as Nueva_Edad,
        m.tres_semanas,
        m.Correo_Misional,
        m.Correo_Personal,
        m.Status,
        m.Rama,
        m.Fecha_nacimiento
      FROM vwMisioneros m
      WHERE (${condicionesRama})
      AND m.Correo_Misional IS NOT NULL
      AND (
        (DAYOFYEAR(m.Fecha_nacimiento) BETWEEN DAYOFYEAR(CURDATE() - INTERVAL 7 DAY) AND DAYOFYEAR(CURDATE()))
        OR 
        (MONTH(m.Fecha_nacimiento) = MONTH(CURDATE()) AND DAY(m.Fecha_nacimiento) <= DAY(CURDATE()))
      )
      LIMIT 1
    `;
    
    console.log(`üîç Consulta de prueba: ${sql}`);
    
    const stmt = conn.createStatement();
    const results = stmt.executeQuery(sql);
    
    if (results.next()) {
      const misionero = {
        id: results.getInt('ID'),
        tipo: results.getString('Tipo'),
        tratamiento: results.getString('Tratamiento'),
        nombre: results.getString('Nombre_del_misionero'),
        nuevaEdad: results.getInt('Nueva_Edad'),
        tresSemanas: results.getBoolean('tres_semanas'),
        correoMisional: results.getString('Correo_Misional'),
        correoPersonal: results.getString('Correo_Personal'),
        status: results.getString('Status'),
        rama: results.getInt('Rama')
      };
      
      console.log(`üéØ Enviando correo de prueba a: ${misionero.nombre} (Rama ${misionero.rama}, ${misionero.status})`);
      enviarCorreoIndividual(misionero);
      console.log("‚úÖ Correo de prueba enviado exitosamente");
    } else {
      console.log("‚ö†Ô∏è No se encontraron misioneros para la prueba en las ramas autorizadas");
      console.log(`üìã Ramas autorizadas: ${RAMAS_AUTORIZADAS.join(', ')}`);
      RAMAS_AUTORIZADAS.forEach(rama => {
        console.log(`   Rama ${rama}: ${obtenerEstatusValidosPorRama(rama).join(', ')}`);
      });
    }
    
    results.close();
    stmt.close();
    
  } catch (error) {
    console.error(`‚ùå Error en prueba: ${error.message}`);
  } finally {
    if (conn && !conn.isClosed()) {
      conn.close();
    }
  }
}

/**
 * Funci√≥n para cambiar entre modo prueba y producci√≥n
 * No modifica el archivo, solo para verificar configuraci√≥n actual
 */
function verificarConfiguracion() {
  console.log("‚öôÔ∏è ===== CONFIGURACI√ìN ACTUAL =====");
  console.log(`üîß Modo prueba: ${MODO_PRUEBA ? 'ACTIVADO' : 'DESACTIVADO'}`);
  console.log(`üë§ Simulaci√≥n: ${SIMULAR_HERMANA ? 'Hermana' : '√âlder'}`);
  console.log(`üìß Correo de prueba: ${CORREO_PRUEBA}`);
  console.log(`üë§ Nombre de prueba: ${NOMBRE_PRUEBA}`);
  console.log(`üè¢ Ramas autorizadas: ${RAMAS_AUTORIZADAS.join(', ')}`);
  
  console.log("\nüìã Estatus por rama:");
  RAMAS_AUTORIZADAS.forEach(rama => {
    console.log(`   Rama ${rama}: ${obtenerEstatusValidosPorRama(rama).join(', ')}`);
  });
  
  console.log(`\nüì§ Remitente: ${REMITENTE_NOMBRE} <${REMITENTE_EMAIL}>`);
  console.log(`üìß Correo personal: ${CORREO_PERSONAL}`);
  
  if (MODO_PRUEBA) {
    console.log("\n‚ö†Ô∏è RECORDATORIO: Para usar en producci√≥n, cambia MODO_PRUEBA a false");
    console.log("üìù Para cambiar el tipo de misionero simulado, modifica SIMULAR_HERMANA");
  } else {
    console.log("\n‚úÖ Configurado para producci√≥n");
    console.log("üóìÔ∏è Se ejecutar√° autom√°ticamente con el trigger diario a las 6:00 AM");
  }
  
  console.log("‚öôÔ∏è ===== FIN CONFIGURACI√ìN =====");
}

/**
 * Funci√≥n para obtener estad√≠sticas de cumplea√±os pr√≥ximos
 */
function obtenerEstadisticasCumpleanos() {
  let conn;
  
  try {
    const url = `jdbc:mysql://${dbConfig.host}:${dbConfig.port}/${dbConfig.dbName}?useUnicode=true&characterEncoding=utf8`;
    conn = Jdbc.getConnection(url, dbConfig.user, dbConfig.password);
    
    // Establecer collation para la sesi√≥n
    const collationStmt = conn.createStatement();
    collationStmt.execute("SET collation_connection = utf8mb4_unicode_ci");
    collationStmt.execute("SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci");
    collationStmt.close();
    
    // Construir condiciones din√°micas para cada rama autorizada
    const condicionesRama = RAMAS_AUTORIZADAS.map(rama => {
      const estatusValidos = obtenerEstatusValidosPorRama(rama);
      const estatusString = estatusValidos.map(s => `'${s}'`).join(',');
      return `(e.Rama = ${rama} AND e.Status IN (${estatusString}))`;
    }).join(' OR ');
    
    const sql = `
      SELECT 
        e.Fecha_Cumple,
        e.Rama,
        e.Cantidad,
        e.Misioneros
      FROM vwEstadisticasCumpleanos e
      WHERE (${condicionesRama})
      ORDER BY 
        CASE 
          WHEN e.Mes = MONTH(CURDATE()) THEN 1
          WHEN e.Mes = MONTH(DATE_ADD(CURDATE(), INTERVAL 1 MONTH)) THEN 2
          ELSE 3
        END,
        e.Dia,
        e.Rama
    `;
    
    const stmt = conn.createStatement();
    const results = stmt.executeQuery(sql);
    
    console.log("üìä Pr√≥ximos cumplea√±os (filtrado por ramas autorizadas):");
    console.log("========================================================");
    console.log(`üéØ Ramas incluidas: ${RAMAS_AUTORIZADAS.join(', ')}`);
    RAMAS_AUTORIZADAS.forEach(rama => {
      console.log(`   Rama ${rama}: ${obtenerEstatusValidosPorRama(rama).join(', ')}`);
    });
    console.log("========================================================");
    
    while (results.next()) {
      const fecha = results.getString('Fecha_Cumple');
      const rama = results.getInt('Rama');
      const cantidad = results.getInt('Cantidad');
      const misioneros = results.getString('Misioneros');
      
      console.log(`${fecha} - Rama ${rama}: ${cantidad} misionero(s)`);
      console.log(`   ${misioneros}`);
      console.log("");
    }
    
    results.close();
    stmt.close();
    
  } catch (error) {
    console.error(`‚ùå Error obteniendo estad√≠sticas: ${error.message}`);
  } finally {
    if (conn && !conn.isClosed()) {
      conn.close();
    }
  }
}

// ===============================================
// INSTRUCCIONES PARA USAR EL MODO PRUEBA
// ===============================================
/*

CONFIGURACI√ìN DE PRUEBA:
1. MODO_PRUEBA = true (activar modo prueba)
2. SIMULAR_HERMANA = true/false (tipo de misionero a simular)
3. CORREO_PRUEBA = "tuCorreo@gmail.com" (tu correo para recibir pruebas)
4. NOMBRE_PRUEBA = "Tu Nombre" (nombre para la simulaci√≥n)

FUNCIONES DISPONIBLES:

1. ejecutarPrueba()
   - Ejecuta una prueba completa del sistema
   - Crea un misionero simulado y env√≠a correo a tu correo personal
   - No requiere conexi√≥n a base de datos

2. verificarConfiguracion()
   - Muestra la configuraci√≥n actual del sistema
   - √ötil para verificar settings antes de ejecutar

3. enviarCorreosCumpleanos()
   - Funci√≥n principal que respeta el modo MODO_PRUEBA
   - En modo prueba: env√≠a correo simulado
   - En modo producci√≥n: consulta base de datos real

4. obtenerEstadisticasCumpleanos()
   - Siempre consulta la base de datos real
   - Muestra cumplea√±os pr√≥ximos filtrados por ramas autorizadas

PASOS PARA PROBAR:
1. Aseg√∫rate de que MODO_PRUEBA = true
2. Configura tu correo en CORREO_PRUEBA
3. Ejecuta: ejecutarPrueba()
4. Revisa tu bandeja de entrada
5. Para producci√≥n, cambia MODO_PRUEBA = false

NOTAS:
- En modo prueba, el asunto incluye [PRUEBA]
- No se usa BCC en modo prueba
- Los datos del misionero son completamente simulados
- Se respetan las configuraciones de ramas y estatus

*/
